<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: Langchain - Asher Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Asher Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Asher Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Asher Blog"><meta property="og:url" content="https://im-asher.github.io/"><meta property="og:site_name" content="Asher Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://im-asher.github.io/img/og_image.png"><meta property="article:author" content="Asher"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://im-asher.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://im-asher.github.io"},"headline":"Asher Blog","image":["https://im-asher.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Asher"},"publisher":{"@type":"Organization","name":"Asher Blog","logo":{"@type":"ImageObject","url":"https://im-asher.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Asher Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags/">Tags</a></li><li class="is-active"><a href="#" aria-current="page">Langchain</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2026-02-26T14:13:25.000Z" title="2/26/2026, 10:13:25 PM">2026-02-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2026-02-27T14:01:18.924Z" title="2/27/2026, 10:01:18 PM">2026-02-27</time></span><span class="level-item"><a class="link-muted" href="/categories/%E5%B7%A5%E7%A8%8B%E5%A4%8D%E7%9B%98/">工程复盘</a></span><span class="level-item">12 minutes read (About 1807 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2026/02/26/how-to-build-valid-sql-tool-in-agent/">Langchain 构建SQL Agent中遇到的坑</a></p><div class="content"><h2 id="1-什么是langchain"><a href="#1-什么是langchain" class="headerlink" title="1.什么是langchain"></a>1.什么是langchain</h2><p>LangChain 是一个开源的软件开发框架，旨在简化由大型语言模型（LLM）（如 GPT-4、Claude、Llama 等）驱动的应用程序的开发过程。<br>简单来说，如果把大语言模型比作一个“大脑”，那么 LangChain 就是给这个大脑装上了“四肢”（工具）、“耳朵”（数据输入）和“记事本”（记忆），让它能够真正地去执行复杂的任务，而不仅仅是陪你聊天。</p>
<h2 id="2-如何利用langchain来快速构建自己的sql-agent"><a href="#2-如何利用langchain来快速构建自己的sql-agent" class="headerlink" title="2.如何利用langchain来快速构建自己的sql-agent"></a>2.如何利用langchain来快速构建自己的sql-agent</h2><h3 id="2-1-安装必要的库"><a href="#2-1-安装必要的库" class="headerlink" title="2.1 安装必要的库"></a>2.1 安装必要的库</h3><p>需要安装 LangChain 的核心库、OpenAI 接口库（推荐使用 OpenAI，效果最好）以及社区工具包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv add langchain langchain-community langchain-openai langgraph</span><br></pre></td></tr></table></figure>


<h3 id="2-2-核心代码实现"><a href="#2-2-核心代码实现" class="headerlink" title="2.2 核心代码实现"></a>2.2 核心代码实现</h3><p>为了能直接运行，下面的代码包含了一个临时创建的 SQLite 内存数据库。在实际生产中，你只需要把数据库连接字符串换成你的 MySQL 或 PostgreSQL 地址即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String, MetaData, Table, insert</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 导入 LangChain 相关模块</span></span><br><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits <span class="keyword">import</span> create_sql_agent</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 准备工作：设置 API Key (请替换为你自己的 Key)</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line">os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;sk-...&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># A. 创建一个模拟数据库 (仅用于演示，实际项目中不需要这一步)</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 创建内存数据库</span></span><br><span class="line">engine = create_engine(<span class="string">&quot;sqlite:///:memory:&quot;</span>)</span><br><span class="line">metadata = MetaData()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 &#x27;users&#x27; 表</span></span><br><span class="line">users = Table(</span><br><span class="line">    <span class="string">&quot;users&quot;</span>, metadata,</span><br><span class="line">    Column(<span class="string">&quot;id&quot;</span>, Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&quot;name&quot;</span>, String),</span><br><span class="line">    Column(<span class="string">&quot;age&quot;</span>, Integer),</span><br><span class="line">    Column(<span class="string">&quot;city&quot;</span>, String),</span><br><span class="line">)</span><br><span class="line">metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入一些测试数据</span></span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    conn.execute(insert(users), [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;New York&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">30</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;San Francisco&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Charlie&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">35</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;New York&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;David&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">40</span>, <span class="string">&quot;city&quot;</span>: <span class="string">&quot;London&quot;</span>&#125;,</span><br><span class="line">    ])</span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># B. 连接数据库</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 在实际项目中，URI 可能是 &quot;postgresql://user:pass@localhost:5432/mydb&quot;</span></span><br><span class="line">db = SQLDatabase(engine=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># C. 初始化 LLM (大模型)</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># 建议使用 gpt-4 或 gpt-3.5-turbo，温度设为 0 以保证 SQL 生成的准确性</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># D. 创建 SQL Agent</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># agent_type=&quot;openai-tools&quot; 是目前最高效的模式</span></span><br><span class="line">agent_executor = create_sql_agent(</span><br><span class="line">    llm=llm,</span><br><span class="line">    db=db,</span><br><span class="line">    agent_type=<span class="string">&quot;openai-tools&quot;</span>,</span><br><span class="line">    verbose=<span class="literal">True</span>  <span class="comment"># 开启后可以看到 Agent 的思考过程 (生成的 SQL 等)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line"><span class="comment"># E. 运行查询</span></span><br><span class="line"><span class="comment"># ==========================================</span></span><br><span class="line">query = <span class="string">&quot;来自 New York 的用户平均年龄是多少？&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;用户提问: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = agent_executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: query&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n最终回答: <span class="subst">&#123;response[<span class="string">&#x27;output&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h2 id="3-内置方法的弊端"><a href="#3-内置方法的弊端" class="headerlink" title="3.内置方法的弊端"></a>3.内置方法的弊端</h2><p>虽然 create_sql_agent 和 SQLDatabase 等内置方法非常适合快速构建原型（Demo），但在生产环境中直接使用它们，通常会遇到很多严重的瓶颈和风险。</p>
<p>以下是 LangChain 内置 SQL Agent 方法的主要弊端：</p>
<h3 id="3-1-Token-消耗与上下文限制"><a href="#3-1-Token-消耗与上下文限制" class="headerlink" title="3.1 Token 消耗与上下文限制"></a>3.1 Token 消耗与上下文限制</h3><p>这是最常见的问题。内置方法通常会将数据库的 <strong>表结构（Schema）</strong> 直接放入Prompt中发送给LLM。</p>
<ul>
<li>弊端：如果你的数据库有 100 张表，或者表中有几百个字段，Prompt 会瞬间变得非常长，甚至超过 LLM 的上下文窗口限制（Context Limit）。</li>
</ul>
<p>这就会造成</p>
<ul>
<li>每次查询都要发送几千个 Token 的表结构，API 费用极高（自己部署）。</li>
<li>LLM 面对过多的无关表信息，注意力会被分散，导致推理能力下降，选错表或字段</li>
</ul>
<h3 id="3-2-缺乏领域知识"><a href="#3-2-缺乏领域知识" class="headerlink" title="3.2 缺乏领域知识"></a>3.2 缺乏领域知识</h3><p>LLM 懂 SQL 语法，但它不懂业务逻辑。</p>
<ul>
<li>弊端：数据库字段名往往是缩写或晦涩的（如 t_stat_01, is_del）。内置 Agent 只能根据字段名“猜”意思。</li>
</ul>
<p>这就会造成生成的 SQL 语法正确，但业务结果是错的。</p>
<h3 id="3-3-幻觉与错误"><a href="#3-3-幻觉与错误" class="headerlink" title="3.3 幻觉与错误"></a>3.3 幻觉与错误</h3><ul>
<li>弊端：LLM 可能会臆造不存在的列名，或者混淆相似的列名</li>
<li>后果：虽然内置 Agent 有“自动纠错机制”（执行报错 -&gt; 把错误发回 LLM -&gt; LLM 重写 SQL），但这会增加延迟和 Token 消耗，而且不一定能修好。</li>
</ul>
<h2 id="4-如何解决"><a href="#4-如何解决" class="headerlink" title="4.如何解决"></a>4.如何解决</h2><h3 id="4-1-RAG-for-Schema"><a href="#4-1-RAG-for-Schema" class="headerlink" title="4.1 RAG for Schema"></a>4.1 RAG for Schema</h3><p>把表名和列的描述存入向量数据库。当用户提问时，先检索出最相关的 3-5 张表，只把这几张表的结构发给 LLM</p>
<h3 id="4-2-构建自己的database-tools"><a href="#4-2-构建自己的database-tools" class="headerlink" title="4.2 构建自己的database tools"></a>4.2 构建自己的database tools</h3><p>原有SQLDatabaseToolkit一次性会获取完整的表格数据，但是实际需要的字段数据不多，因此会造成过多无关字段、敏感数据或消耗大量Token，因此可以构建自己Database tools，工具主要针对以下进行优化</p>
<ul>
<li>白名单&#x2F;黑名单机制：只向 LLM 暴露特定的表和字段。</li>
<li>简化 Schema 格式：不发送完整的 CREATE TABLE 语句，只发送简单的 列名: 类型 描述。</li>
<li>禁止获取样本数据：内置工具通常会查询前 3 行数据作为样本，自定义工具可以完全禁止这一行为。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_safe_table_schema</span>(<span class="params">table_name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取指定表的结构信息。</span></span><br><span class="line"><span class="string">    只返回允许访问的字段，不包含敏感字段或样本数据。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> table_name <span class="keyword">not</span> <span class="keyword">in</span> VISIBLE_SCHEMA:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error: Table &#x27;<span class="subst">&#123;table_name&#125;</span>&#x27; does not exist or access is denied.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用 SQLAlchemy Inspector 获取真实的列信息</span></span><br><span class="line">    inspector = inspect(engine)</span><br><span class="line">    columns = inspector.get_columns(table_name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 过滤字段</span></span><br><span class="line">    allowed_columns = VISIBLE_SCHEMA[table_name]</span><br><span class="line">    safe_columns_info = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> columns:</span><br><span class="line">        <span class="keyword">if</span> col[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">in</span> allowed_columns:</span><br><span class="line">            <span class="comment"># 拼接成简化的格式: &quot;name (VARCHAR)&quot;</span></span><br><span class="line">            col_str = <span class="string">f&quot;<span class="subst">&#123;col[<span class="string">&#x27;name&#x27;</span>]&#125;</span> (<span class="subst">&#123;col[<span class="string">&#x27;type&#x27;</span>]&#125;</span>)&quot;</span></span><br><span class="line">            safe_columns_info.append(col_str)</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># 构造返回给 LLM 的文本</span></span><br><span class="line">    schema_text = <span class="string">f&quot;Table: <span class="subst">&#123;table_name&#125;</span>\nColumns:\n&quot;</span> + <span class="string">&quot;\n&quot;</span>.join(<span class="string">f&quot;- <span class="subst">&#123;c&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> safe_columns_info)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> schema_text</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>LangChain 的 create_sql_agent 就像一把瑞士军刀，能让我们在 5 分钟内快速验证“Text-to-SQL”的可行性。然而，当我们试图将其推向生产环境时，“开箱即用”的便利性往往伴随着不可控的风险。</p>
<p>从 Demo 到 Production 的跨越，本质上是一场关于 <strong>Context（上下文）与Control（控制权）</strong> 的博弈：</p>
<p>拒绝暴力填充：不再将整个数据库 Schema 一股脑塞给 LLM，而是通过 RAG（检索增强生成） 按需加载相关表，解决 Token 爆炸和注意力分散问题。<br>精细化权限管理：放弃粗粒度的内置工具，转而构建自定义 Database Tools。通过白名单机制和 Schema 简化，既保护了敏感数据（如密码、薪资），又大幅降低了 API 成本。</p>
<p>注入业务语义：LLM 懂 SQL 语法但不懂业务逻辑。通过自定义工具层，我们可以将复杂的业务规则（如“毛利计算方式”）封装在工具内部，而不是依赖模型去“猜”。<br>一句话概括：在构建企业级 SQL Agent 时，不要迷信 LangChain 的“魔法”，只有通过自定义工具将数据库的解释权和访问权牢牢掌握在自己手中，才能构建出既安全又精准的智能应用。</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="Asher"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Asher</p><p class="is-size-6 is-block">AI Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen, Guangdong</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives/"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories/"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags/"><p class="title">4</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Im-Asher" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/Im-Asher"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E7%A8%8B%E5%A4%8D%E7%9B%98/"><span class="level-start"><span class="level-item">工程复盘</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AE%BA%E6%96%87%E5%A4%8D%E7%9B%98/"><span class="level-start"><span class="level-item">论文复盘</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-02-26T14:13:25.000Z">2026-02-26</time></p><p class="title"><a href="/2026/02/26/how-to-build-valid-sql-tool-in-agent/">Langchain 构建SQL Agent中遇到的坑</a></p><p class="categories"><a href="/categories/%E5%B7%A5%E7%A8%8B%E5%A4%8D%E7%9B%98/">工程复盘</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-02-25T13:19:19.000Z">2026-02-25</time></p><p class="title"><a href="/2026/02/25/Rethinking-Memory-in-LLM-based-Agents/">Rethinking Memory in LLM based Agents - Representations, Operations, and Emerging Topics</a></p><p class="categories"><a href="/categories/%E8%AE%BA%E6%96%87%E5%A4%8D%E7%9B%98/">论文复盘</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2026-02-20T06:33:42.097Z">2026-02-20</time></p><p class="title"><a href="/2026/02/20/hello-world/">Hello World</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2026/02/"><span class="level-start"><span class="level-item">February 2026</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Agent/"><span class="tag">Agent</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Langchain/"><span class="tag">Langchain</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Memory/"><span class="tag">Memory</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SQL-Agent/"><span class="tag">SQL-Agent</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Asher Blog" height="28"></a><p class="is-size-7"><span>&copy; 2026 Asher</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>